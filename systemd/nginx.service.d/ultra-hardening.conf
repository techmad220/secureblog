# Ultra-hardened systemd configuration for SecureBlog nginx
# Place in: /etc/systemd/system/nginx.service.d/ultra-hardening.conf

[Service]
# Core Security
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectKernelLogs=true
ProtectControlGroups=true
ProtectProc=invisible
ProtectHostname=true
ProtectClock=true

# Namespace Isolation
PrivateDevices=yes
PrivateUsers=yes
PrivateIPC=yes
RemoveIPC=yes

# Filesystem Protection
ReadWritePaths=
ReadOnlyPaths=/var/www/secureblog
InaccessiblePaths=/home /root /boot /opt /mnt /media
TemporaryFileSystem=/var:ro
BindReadOnlyPaths=/var/www/secureblog:/var/www/secureblog:ro

# Network Restrictions
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
IPAccounting=yes
IPAddressDeny=any
IPAddressAllow=localhost

# Resource Limits
LimitNOFILE=1024
LimitNPROC=64
LimitCORE=0
TasksMax=16
MemoryMax=256M
MemoryHigh=128M
CPUQuota=50%

# Capabilities
CapabilityBoundingSet=
AmbientCapabilities=

# System Calls
SystemCallFilter=@system-service @network-io @basic-io
SystemCallFilter=~@privileged @resources @mount @swap @reboot @clock @debug @module @raw-io @cpu-emulation @obsolete
SystemCallErrorNumber=EPERM
SystemCallArchitectures=native

# Personality & Execution
LockPersonality=yes
MemoryDenyWriteExecute=yes
RestrictSUIDSGID=yes
RestrictRealtime=yes
RestrictNamespaces=yes

# Hardening Flags
ProcSubset=pid
KeyringMode=private
UMask=0077
NotifyAccess=none

# Additional Sandboxing
DevicePolicy=closed
RestrictFileSystems=~proc sysfs debugfs tracefs fusectl binfmt_misc configfs rpc_pipefs autofs fuse overlay mqueue hugetlbfs devpts

# Security Labels (if using SELinux/AppArmor)
# SELinuxContext=system_u:system_r:nginx_t:s0
# AppArmorProfile=nginx-secureblog

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=nginx-secureblog

# Runtime
RuntimeDirectory=nginx-secureblog
RuntimeDirectoryMode=0700
StateDirectory=nginx-secureblog
StateDirectoryMode=0700
CacheDirectory=nginx-secureblog
CacheDirectoryMode=0700

# Process
Type=forking
PIDFile=/run/nginx-secureblog.pid
ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx-secureblog.conf
ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx-secureblog.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
Restart=on-failure
RestartSec=5s

# Watchdog
WatchdogSec=10s

# Kill Mode
KillMode=mixed
KillSignal=SIGQUIT
TimeoutStopSec=5s
FinalKillSignal=SIGKILL